= Roomカラムを追加する方法

割とつまずいたので記録。

== DBのバージョンを上げる

[source,kotlin]
----
@Database(entities = arrayOf(HogeEntity::class), version = 2)
abstract class HogeDatabase : RoomDatabase() {
    ...
}
----

== マイグレーション関数の作成

[source,kotlin]
----
val migration1To2 = object : Migration(1, 2) {
    override fun migrate(database: SupportSQLiteDatabase) {
        database.execSQL("ALTER TABLE hoge ADD fuga TEXT")
    }
}
----

== 作成したマイグレーションを利用する

[source,kotlin]
----
val instance = Room.databaseBuilder(context, HogeDatabase::class.java, "database")
    .addMigrations(migration1To2)
    .build()
----

これで実行すればDBのバージョンアップが行われる。

== 注意
新しく追加するカラムをEntityに追加する際には**オプショナル型**にすること。
旧バージョンで追加されたデータには新しく追加するカラムの情報は無いため
``NULL``が入り``NOT NULL``制約を満たさずエラーが発生する。
当たり前のことだが、ここに気づけず時間を使ってしまった。

``database.execSQL()``を実行するタイミングで既存データに対して追加するカラムの情報を追加すればこの問題は回避できるはず。
代わりに、既存データ量が多い場合は追加に時間がかかってしまうはず。
そこを許容できればKotlin的にはそっちの方が遙かに良い。